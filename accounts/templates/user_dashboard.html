{% extends "base.html" %}
{% load static %}

{% block signup %}{% endblock %}
{% block user_type %}{% endblock %}

{% block user_avatar %}
<div class="user-info-container">
  <div class="avatar" id="user-avatar">{{ request.user.username|slice:":1"|upper }}</div>
  <div class="user-dropdown" id="user-dropdown-menu">
    <div class="user-meta">
      <h2>{{ request.user.get_full_name|default:request.user.username }}</h2>
      <div class="username">(@{{ request.user.username }})</div>
      <div>{{ request.user.email }}</div>
    </div>
    <div class="referral">
      <div>Your Referral Code</div>
      <div class="code">{{ request.user.userprofile.referral_code|default:request.user.username }}</div>
      <div class="small">Share this code with friends</div>
    </div>
    {% if request.user.userprofile.mobile %}
    <div class="user-details">
      <div class="small">Mobile: {{ request.user.userprofile.mobile }}</div>
    </div>
    {% endif %}
    {% if request.user.userprofile.dob %}
    <div class="user-details">
      <div class="small">DOB: {{ request.user.userprofile.dob }}</div>
    </div>
    {% endif %}
    <div class="logout">
      <form method="post" action="{% url 'logout' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="logout-btn" id="logoutBtn">Logout</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="user-dashboard">

  <!-- Floating WhatsApp Invite Button -->
  <div class="floating-whatsapp-btn" onclick="inviteFriendWhatsApp()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.893 3.388"/>
    </svg>
    <div style="font-size: 10px; font-weight: 600; text-align: center; line-height: 1.1;">
      Invite Friends
    </div>

  </div>

  <section>
    <div class="plan-status">
      <h2>My Plan Status</h2>
      <div class="current-plan">
        {% if request.user.userprofile.plan == 'NONE' %}
          <span class="plan-badge plan-none">No Plan Assigned</span>
          <p>Contact admin to get a plan assigned</p>
        {% else %}
          <span class="plan-badge plan-{{ request.user.userprofile.plan|lower }}">{{ request.user.userprofile.plan }} Plan</span>
          <p>You have access to {{ request.user.userprofile.plan }} level courses</p>
        {% endif %}
      </div>
    </div>
  </section>


  <!-- Referrals Section - Before Courses -->
  <section>
    <div class="referrals-section">
      <h3>My Referrals Overview</h3>
      
      <!-- Total Referrals & Earnings Summary -->
      <div class="referral-summary" style="display: flex; justify-content: center; gap: 25px; flex-wrap: wrap; margin-bottom: 30px;">
        <div class="total-referrals-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25); flex: 1; min-width: 250px; max-width: 350px; text-align: center;">
          <h4 style="margin: 0 0 15px 0; font-size: 1.3rem; font-weight: 600; opacity: 0.9;">Total Direct Referrals</h4>
          <span class="total-count" style="font-size: 2.2rem; font-weight: 800; display: block; line-height: 1.1;">{{ total_direct }}</span>
        </div>
        
        <div class="total-earnings-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.25); flex: 1; min-width: 250px; max-width: 350px; text-align: center;">
          <h4 style="margin: 0 0 15px 0; font-size: 1.3rem; font-weight: 600; opacity: 0.9;">Total Commission Earnings</h4>
          <span class="total-amount" style="font-size: 2.2rem; font-weight: 800; display: block; line-height: 1.1;">Rs.{{ total_commission|floatformat:0 }}</span>
        </div>
      </div>
      
      <!-- Plan-wise Referral Breakdown -->
      <div class="plan-referrals-breakdown">
        <h4>Referrals by Plan</h4>
        <div class="plan-cards-container">
          
          <!-- Pro Plan Referrals -->
          <div class="plan-referral-card pro-plan">
            <div class="plan-header">
              <h5>PRO Plan</h5>
              <span class="plan-count">{{ plan_totals.PRO|default:0 }}</span>
            </div>
          </div>
          
          <!-- Advance Plan Referrals -->
          <div class="plan-referral-card advance-plan">
            <div class="plan-header">
              <h5>ADVANCE Plan</h5>
              <span class="plan-count">{{ plan_totals.ADVANCE|default:0 }}</span>
            </div>
          </div>
          
          <!-- Standard Plan Referrals -->
          <div class="plan-referral-card standard-plan">
            <div class="plan-header">
              <h5>STANDARD Plan</h5>
              <span class="plan-count">{{ plan_totals.STANDARD|default:0 }}</span>
            </div>
          </div>
          
          <!-- Basic Plan Referrals -->
          <div class="plan-referral-card basic-plan">
            <div class="plan-header">
              <h5>BASIC Plan</h5>
              <span class="plan-count">{{ plan_totals.BASIC|default:0 }}</span>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </section>

  <!-- Team Rewards Section -->
  <section class="rewards-section">
    <div class="rewards-container">
      <h3>üèÜ Team Reward Progress</h3>
      <p class="rewards-subtitle">Complete referral milestones to unlock amazing rewards!</p>
      
      <!-- Reward Instructions -->
      {% comment %} <div class="reward-instructions">
        <h4>üìã Clear Instructions:</h4>
        <ul>
          <li><strong>Basic/Standard Plan referrals</strong> pe koi condition nahi</li>
          <li><strong>100+ referrals</strong> ke liye Advance/Pro referrals zaroori</li>
          <li><strong>Jitne zyada premium referrals,</strong> utna asaan reward milna</li>
        </ul>
      </div> {% endcomment %}

      <!-- Rewards Grid -->
      <div class="rewards-grid">
        {% for progress in reward_progress %}
        <div class="reward-card {% if progress.is_eligible %}eligible{% endif %} {% if progress.is_achieved %}achieved{% endif %}">
          
          <!-- Reward Header -->
          <div class="reward-header">
            <div class="reward-icon">
              {% if progress.reward.referrals_required <= 50 %}üéÅ
              {% elif progress.reward.referrals_required <= 100 %}üéØ
              {% elif progress.reward.referrals_required <= 300 %}üì±
              {% elif progress.reward.referrals_required <= 500 %}üèçÔ∏è
              {% else %}üïã
              {% endif %}
            </div>
            <h4>{{ progress.reward.reward_name }}</h4>
            <div class="reward-amount">Rs. {{ progress.reward.reward_amount|floatformat:0 }}</div>
          </div>

          <!-- Progress Bars -->
          <div class="progress-section">
            
            <!-- Total Referrals Progress -->
            <div class="progress-item">
              <div class="progress-label">
                <span>Total Referrals</span>
                <span class="progress-count">{{ total_direct }}/{{ progress.reward.referrals_required }}</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: {{ progress.total_referrals_progress }}%"></div>
              </div>
              <div class="progress-percentage">{{ progress.total_referrals_progress|floatformat:0 }}%</div>
            </div>

            <!-- Advance Plan Progress (if required) -->
            {% if progress.reward.advance_referrals_required > 0 %}
            <div class="progress-item advance-progress">
              <div class="progress-label">
                <span>Advance Plan</span>
                <span class="progress-count">{{ plan_totals.ADVANCE|default:0 }}/{{ progress.reward.advance_referrals_required }}</span>
              </div>
              <div class="progress-bar advance-bar">
                <div class="progress-fill" style="width: {{ progress.advance_progress }}%"></div>
              </div>
              <div class="progress-percentage">{{ progress.advance_progress|floatformat:0 }}%</div>
            </div>
            {% endif %}

            <!-- Pro Plan Progress (if required) -->
            {% if progress.reward.pro_referrals_required > 0 %}
            <div class="progress-item pro-progress">
              <div class="progress-label">
                <span>Pro Plan</span>
                <span class="progress-count">{{ plan_totals.PRO|default:0 }}/{{ progress.reward.pro_referrals_required }}</span>
              </div>
              <div class="progress-bar pro-bar">
                <div class="progress-fill" style="width: {{ progress.pro_progress }}%"></div>
              </div>
              <div class="progress-percentage">{{ progress.pro_progress|floatformat:0 }}%</div>
            </div>
            {% endif %}

          </div>

          <!-- Conditions -->
          <div class="reward-conditions">
            {% if progress.reward.condition_text %}
              <div class="condition-text">{{ progress.reward.condition_text }}</div>
            {% else %}
              <div class="condition-text no-conditions">No Condition</div>
            {% endif %}
          </div>

          <!-- Status Badge -->
          <div class="reward-status">
            {% if progress.is_achieved %}
              <span class="status-badge achieved">‚úÖ Achieved!</span>
            {% elif progress.is_eligible %}
              <span class="status-badge eligible">üéâ Eligible!</span>
            {% else %}
              <span class="status-badge pending">‚è≥ In Progress</span>
            {% endif %}
          </div>

          <!-- What's Needed -->
          {% if not progress.is_eligible and not progress.is_achieved %}
          <div class="whats-needed">
            <h5>What's needed:</h5>
            {% if progress.referrals_needed > 0 %}
              <div class="need-item">+{{ progress.referrals_needed }} more referrals</div>
            {% endif %}
            {% if progress.advance_needed > 0 %}
              <div class="need-item">+{{ progress.advance_needed }} Advance plan referrals</div>
            {% endif %}
            {% if progress.pro_needed > 0 %}
              <div class="need-item">+{{ progress.pro_needed }} Pro plan referrals</div>
            {% endif %}
          </div>
          {% endif %}

        </div>
        {% empty %}
        <div class="no-rewards">
          <p>No rewards configured yet. Check back soon!</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <section>
    <div class="plan-title">My Courses</div>
    <div class="courses-row">
        {% if my_courses.exists %}
            <div class="courses-container">
                {% for course in my_courses %}
                    <div class="card" style="width: 18rem;">
                        <div class="card-image-container">
                            <!-- Course Image -->
                            {% if course.thumbnail %}
                                <img src="{{ course.thumbnail.url }}" class="card-img-top" alt="{{ course.title }}">
                            {% else %}
                                <div class="card-img-top card-img-placeholder">
                                    <!-- Empty placeholder -->
                                </div>
                            {% endif %}
                            
                            <!-- Plan Badge -->
                            <div class="card-badge-container">
                                {% if course.plan %}
                                    <span class="card-badge badge-{{ course.plan.name|lower }}">{{ course.plan.name }}</span>
                                {% else %}
                                    <span class="card-badge badge-free">FREE</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Card Body -->
                        <div class="card-body">
                            <div class="card-content">
                                <h5 class="card-title">{{ course.title }}</h5>
                                
                                <div class="card-description">
                                    <p class="card-text" id="desc-{{ forloop.counter }}" data-full="{{ course.description|default_if_none:'No description available.' }}" data-expanded="false">
                                        {{ course.description|default_if_none:"No description available."|truncatechars:100 }}
                                    </p>
                                    
                                    {% if course.description|length > 100 %}
                                        <button class="see-more-btn" onclick="toggleText({{ forloop.counter }})">
                                            See More
                                        </button>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="card-action">
                                {% if course.course_link %}
                                    <a href="{{ course.course_link }}" target="_blank" class="course-btn course-btn-primary">
                                        <i class="fas fa-play-circle"></i> Start Learning
                                    </a>
                                {% else %}
                                    <button class="course-btn course-btn-secondary" disabled>
                                        <i class="fas fa-clock"></i> Coming Soon
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-courses">
              {% if request.user.userprofile.plan == 'NONE' %}
                <h3>No Plan Assigned</h3>
                <p>Contact your admin to get a plan assigned and unlock courses.</p>
              {% else %}
                <h3>No Courses Available</h3>
                <p>No courses are currently available for your {{ request.user.userprofile.plan }} plan.</p>
              {% endif %}
            </div>
        {% endif %}
    </div>
  </section>

</div>

<script>
function toggleDescription(button) {
    const wrapper = button.parentElement;
    const description = wrapper.querySelector('.course-description');
    const fullText = description.getAttribute('data-full-text');
    const isExpanded = button.textContent === 'See Less';
    
    if (isExpanded) {
        // Collapse
        description.textContent = fullText.length > 100 ? fullText.substring(0, 97) + '...' : fullText;
        button.textContent = 'See More';
        button.classList.remove('expanded');
    } else {
        // Expand
        description.textContent = fullText;
        button.textContent = 'See Less';
        button.classList.add('expanded');
    }
}

// WhatsApp Invite Function
function inviteFriendWhatsApp() {
    const referralCode = '{{ request.user.userprofile.referral_code|default:request.user.username }}';
    const websiteUrl = 'https://afaaelevate.com';
    
    // Clean message without emojis
    const message = `Join AFAA Elevate and unlock amazing learning opportunities!

Why Join AFAA Elevate?
‚Ä¢ Premium courses and training
‚Ä¢ Referral rewards and commissions
‚Ä¢ Professional skill development
‚Ä¢ Exclusive content access

ÔøΩ Visit: ${websiteUrl}

Referral Code: ${referralCode}

Let's grow together and achieve success!`;
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}
</script>

{% endblock %}